local Library = {
	FlightSpeed = 60,
    Flight = false
}

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- สถานะการบิน
local currentVelocity = Vector3.new(0,0,0)

-- Body movers
local bodyVelocity, bodyGyro

-- ค่าตั้งต้น
local SPRINT_MULT = 2
local ASCEND_SPEED = 40
local ACCELERATION = 8

-- คีย์บอร์ด
local inputState = {
    forward = 0,
    back = 0,
    left = 0,
    right = 0,
    ascend = 0,
    descend = 0,
    sprint = 0
}

--// ฟังก์ชันสร้าง/ลบ body movers
local function createBodies()

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    bodyVelocity.Velocity = Vector3.zero
    bodyVelocity.Parent = hrp

    bodyGyro = Instance.new("BodyGyro")
    bodyGyro.MaxTorque = Vector3.new(4e5, 4e5, 4e5)
    bodyGyro.P = 2000
    bodyGyro.CFrame = hrp.CFrame
    bodyGyro.Parent = hrp
end

local function removeBodies()

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

    if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
    if bodyGyro then bodyGyro:Destroy() bodyGyro = nil end
end

--// เปิด/ปิดบิน
function RealFlight(value)
    if value then
        createBodies()
    else
        removeBodies()
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")
        humanoid.PlatformStand = false
    end
end

--// อัพเดตการเคลื่อนที่
RunService.RenderStepped:Connect(function(dt)
	pcall(function()
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

    if bodyVelocity and bodyGyro then
        local cam = workspace.CurrentCamera
        local look = cam.CFrame.LookVector
        local right = cam.CFrame.RightVector

        local moveDir = look * (inputState.forward - inputState.back)
            + right * (inputState.right - inputState.left)

        if moveDir.Magnitude > 0 then
            moveDir = moveDir.Unit
        end

        local speed = FlightSpeed
        if inputState.sprint == 1 then speed = speed * SPRINT_MULT end

        local targetVel = moveDir * speed
        targetVel = targetVel + Vector3.new(0, (inputState.ascend - inputState.descend) * ASCEND_SPEED, 0)

        currentVelocity = currentVelocity:Lerp(targetVel, math.clamp(ACCELERATION * dt, 0, 1))
        bodyVelocity.Velocity = currentVelocity
        bodyGyro.CFrame = CFrame.new(hrp.Position, hrp.Position + cam.CFrame.LookVector)
    end
    end)
end)

--// คีย์บอร์ด (PC)
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    local key = input.KeyCode
    if key == Enum.KeyCode.W then inputState.forward = 1 end
    if key == Enum.KeyCode.S then inputState.back = 1 end
    if key == Enum.KeyCode.A then inputState.left = 1 end
    if key == Enum.KeyCode.D then inputState.right = 1 end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
    if gpe then return end
    local key = input.KeyCode
    if key == Enum.KeyCode.W then inputState.forward = 0 end
    if key == Enum.KeyCode.S then inputState.back = 0 end
    if key == Enum.KeyCode.A then inputState.left = 0 end
    if key == Enum.KeyCode.D then inputState.right = 0 end
end)

function Library:SetFlightSpeed(Value)
	Library.FlightSpeed = Value
end

function Library:SetFlight(Value)
	Library.Flight = Value
    RealFlight(Value)
end
